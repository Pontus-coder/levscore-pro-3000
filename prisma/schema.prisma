// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String               @id @default(cuid())
  name          String?
  email         String?              @unique
  emailVerified DateTime?
  image         String?
  isSuperAdmin  Boolean              @default(false)
  isBlocked     Boolean              @default(false)
  blockedAt     DateTime?
  blockedReason String?             @db.Text
  accounts      Account[]
  sessions      Session[]
  memberships   OrganizationMember[]
  customFactors CustomFactor[]
  uploads       UploadHistory[]
  invitationsSent Invitation[]       @relation("InvitedBy")
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Organization/Team model
model Organization {
  id          String               @id @default(cuid())
  name        String
  slug        String               @unique
  members     OrganizationMember[]
  suppliers   Supplier[]
  uploads     UploadHistory[]
  invitations Invitation[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

// Links users to organizations with roles
model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           MemberRole   @default(MEMBER)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  joinedAt       DateTime     @default(now())

  @@unique([userId, organizationId])
}

enum MemberRole {
  OWNER   // Full access, can delete org, manage billing
  ADMIN   // Can invite/remove members, full data access
  MEMBER  // Can view and add data, cannot manage members
}

// Invitation tokens for inviting new team members
model Invitation {
  id             String       @id @default(cuid())
  email          String
  organizationId String
  role           MemberRole   @default(MEMBER)
  token          String       @unique
  expiresAt      DateTime
  invitedById    String
  invitedBy      User         @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@unique([email, organizationId])
}

model Supplier {
  id                String         @id @default(cuid())
  supplierNumber    String
  name              String
  organizationId    String
  organization      Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rowCount          Int            @default(0)
  totalQuantity     Int            @default(0)
  totalRevenue      Float          @default(0)
  totalTB           Float          @default(0)  // Total Bruttovinst (för korrekt TG-beräkning)
  avgMargin         Float          @default(0)
  salesScore        Float          @default(0)
  assortmentScore   Float          @default(0)
  efficiencyScore   Float          @default(0)
  marginScore       Float          @default(0)
  totalScore        Float          @default(0)
  diagnosis         String?        @db.Text
  shortAction       String?        @db.Text
  revenueShare      Float          @default(0)
  accumulatedShare  Float          @default(0)
  tier              String?
  profile           String?        @db.Text
  // Nya fält för trends och AI
  keywords          String[]       @default([])  // Sökord för Google Trends
  aiAnalysis        String?        @db.Text      // Cachad AI-analys (JSON)
  aiAnalysisDate    DateTime?                    // När AI-analysen genererades
  // Bonus och anbudsstöd (båda fasta belopp i SEK)
  bonusAmount       Float?                        // Bonus i SEK
  tenderSupport     Float?                        // Anbudsstöd i SEK
  bonusComment      String?        @db.Text      // Kommentar om bonus/anbudsstöd
  // Beräknade fält (justerade för bonus/anbudsstöd)
  adjustedTotalTB   Float?                        // totalTB + bonusAmount + tenderSupport
  adjustedAvgMargin Float?                        // TG baserat på adjustedTotalTB
  adjustedMarginScore Float?                      // marginScore baserat på adjustedAvgMargin
  adjustedTotalScore Float?                       // totalScore med adjustedMarginScore
  customFactors     CustomFactor[]
  articles          Article[]                     // Artiklar för denna leverantör
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@unique([supplierNumber, organizationId])
}

model CustomFactor {
  id          String   @id @default(cuid())
  supplierId  String
  userId      String   // Who added this factor
  factorName  String
  factorValue Float
  weight      Float    @default(1)
  comment     String?  @db.Text
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UploadHistory {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  fileName       String
  recordCount    Int
  status         String       @default("completed")
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedAt     DateTime     @default(now())
}

model Article {
  id              String   @id @default(cuid())
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  articleNumber   String
  description     String?  @db.Text
  quantity        Int      @default(0)
  revenue         Float    @default(0)
  grossProfit     Float?   // TB (Bruttovinst)
  margin          Float?   // TG i procent (beräknas från grossProfit om det finns)
  revenueShare    Float    @default(0)  // Andel av leverantörens totala omsättning
  accumulatedShare Float   @default(0)  // Ackumulerad andel (för ABC-analys)
  category        String?  // A, B, eller C baserat på ABC-analys
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([supplierId])
  @@index([supplierId, revenue])
}
